<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AGPT Kanban Board</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <link rel="stylesheet" href="/assets/css/custom.css">
  <style>
    .kanban-column { min-height: 400px; }
    .kanban-card { cursor: grab; position: relative; border-left: 5px solid transparent; }
    .kanban-card:active { cursor: grabbing; }
    .color-stripe-green { border-left-color: #28a745; }
    .color-stripe-amber { border-left-color: #ffc107; }
    .color-stripe-red { border-left-color: #dc3545; }
    .blocker-overlay { position: absolute; top: 8px; right: 8px; font-size: 1.5rem; line-height: 1; }
    .modal { display: none; } .modal.is-open { display: flex; }
    .debug-info { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px; font-family: monospace; font-size: 12px; }
  </style>
</head>
<body class="bg-gray-100 font-sans">
  <header class="bg-white shadow sticky top-0 z-50">
    <div class="container mx-auto px-4 py-3 flex items-center justify-between gap-4">
      <a href="/" class="flex items-center gap-3 flex-shrink-0">
        <img src="/assets/new-AGPT-logo.svg" alt="AGPT Logo" class="w-12 h-12">
        <span class="font-bold text-gray-700 hidden sm:inline">AGPT Accounting and Business Consultancy</span>
      </a>
      <div class="flex-grow min-w-0 mx-4"><input type="search" id="searchBar" placeholder="Search by client, task, or owner..." class="w-full border px-3 py-2 rounded-lg focus:ring focus:ring-blue-200"></div>
      <div id="user-status" class="flex items-center gap-4 flex-shrink-0">
         <button id="addCardBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 hidden">Add Card</button>
         <button id="debugBtn" class="bg-purple-600 text-white px-2 py-1 rounded text-sm">Debug</button>
         <a id="loginBtn" href="/admin/login.html" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Login</a>
      </div>
    </div>
  </header>

  <!-- Debug Panel -->
  <div id="debugPanel" class="hidden bg-yellow-100 p-4 border-b">
    <h3 class="font-bold">Debug Information</h3>
    <div id="debugContent" class="debug-info"></div>
  </div>

  <main id="board-container" class="container mx-auto p-4 hidden">
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="bg-white rounded-lg shadow"><h2 class="text-xl font-bold p-4 border-b">To Do</h2><div id="col-todo" data-status="To Do" class="p-4 space-y-4 kanban-column"></div></div>
        <div class="bg-white rounded-lg shadow"><h2 class="text-xl font-bold p-4 border-b">In Progress</h2><div id="col-inprogress" data-status="In Progress" class="p-4 space-y-4 kanban-column"></div></div>
        <div class="bg-white rounded-lg shadow"><h2 class="text-xl font-bold p-4 border-b">Review</h2><div id="col-review" data-status="Review" class="p-4 space-y-4 kanban-column"></div></div>
        <div class="bg-white rounded-lg shadow"><h2 class="text-xl font-bold p-4 border-b">Done</h2><div id="col-done" data-status="Done" class="p-4 space-y-4 kanban-column"></div></div>
    </div>
  </main>
  <div id="login-prompt" class="container mx-auto p-8 text-center bg-white mt-8 rounded-lg shadow">
    <h2 class="text-2xl font-bold">Access Denied</h2>
    <p class="mt-2">Please log in to view the Kanban board.</p>
    <a href="/admin/login.html" class="mt-4 inline-block bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">Login</a>
  </div>

  <!-- Enhanced Error Modal -->
  <div id="errorModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
      <h2 id="errorTitle" class="text-2xl font-bold mb-4 text-red-600">Error</h2>
      <p id="errorMessage" class="mb-4"></p>
      <div id="errorDetails" class="debug-info mb-4 hidden"></div>
      <button id="errorClose" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Close</button>
    </div>
  </div>

  <div id="cardModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
      <h2 id="modalTitle" class="text-2xl font-bold mb-4">Add New Card</h2>
      <form id="cardForm">
        <input type="hidden" id="cardId" name="id">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div><label for="client" class="block mb-1">Client</label><input type="text" id="client" name="client" class="w-full border px-3 py-2 rounded" required></div>
          <div><label for="owner" class="block mb-1">Owner</label><input type="text" id="owner" name="owner" class="w-full border px-3 py-2 rounded"></div>
          <div class="md:col-span-2"><label for="task" class="block mb-1">Task</label><textarea id="task" name="task" rows="3" class="w-full border px-3 py-2 rounded" required></textarea></div>
          <div><label for="due_date" class="block mb-1">Due Date</label><input type="date" id="due_date" name="due_date" class="w-full border px-3 py-2 rounded"></div>
          <div><label for="category" class="block mb-1">Category</label><select id="category" name="category" class="w-full border px-3 py-2 rounded"></select></div>
          <div class="md:col-span-2 flex items-center"><input type="checkbox" id="blocker_flag" name="blocker_flag" class="mr-2"><label for="blocker_flag">Is this task blocked?</label></div>
        </div>
        <div class="mt-6 flex justify-end gap-4">
          <button type="button" id="deleteCardBtn" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 hidden">Delete</button>
          <button type="button" id="closeModalBtn" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500">Cancel</button>
          <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Save Card</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const categoryIcons = { 'Bookkeeping': 'ğŸ“š', 'Tax Filing (Current)': 'ğŸ“…', 'Preparation of AFS & filing of ITR': 'ğŸ“Š', 'General Information Sheet Preparation': 'ğŸ“‹', 'BIR LOA Processing': 'âœ‰ï¸ğŸ”', 'Open Case Processing - Tax Returns': 'ğŸ“‚ğŸ”“', 'Business Registration Processing': 'ğŸ¢â•', 'Business Closure Processing': 'ğŸ¢âœ–ï¸', 'Business Permit Renewal Processing': 'ğŸ”„ğŸ“„', 'Certificate of Gross Sales': 'ğŸ’µğŸ“„', 'Amendment of Articles of Incorporation': 'âœï¸ğŸ“œ', 'Annualized Payroll Preparation': 'ğŸ“†ğŸ‘¥', '2316 Preparation': 'ğŸ§¾ğŸ‘¤', 'Preparation of Interim Financial Statements': 'ğŸ“ˆğŸ“„', 'Preparation of In-House Financial Statements': 'ğŸ ğŸ“„', 'Other Engagement': 'â“' };
    let allCards = [];
    let currentUser = null;
    let debugMode = false;

    // Enhanced error handling function
    function showError(title, message, details = null) {
      const modal = document.getElementById('errorModal');
      const titleEl = document.getElementById('errorTitle');
      const messageEl = document.getElementById('errorMessage');
      const detailsEl = document.getElementById('errorDetails');
      
      titleEl.textContent = title;
      messageEl.textContent = message;
      
      if (details && debugMode) {
        detailsEl.textContent = JSON.stringify(details, null, 2);
        detailsEl.classList.remove('hidden');