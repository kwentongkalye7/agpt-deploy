<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AGPT Kanban Board</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <link rel="stylesheet" href="/assets/css/custom.css">
  <style>
    .kanban-column { min-height: 400px; }
    .kanban-card { cursor: grab; position: relative; border-left: 5px solid transparent; }
    .kanban-card:active { cursor: grabbing; }
    .color-stripe-green { border-left-color: #28a745; }
    .color-stripe-amber { border-left-color: #ffc107; }
    .color-stripe-red { border-left-color: #dc3545; }
    .blocker-overlay { position: absolute; top: 8px; right: 8px; font-size: 1.5rem; line-height: 1; }
    .modal { display: none; } .modal.is-open { display: flex; }
    .debug-info { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px; font-family: monospace; font-size: 12px; }
  </style>
</head>
<body class="bg-gray-100 font-sans">
  <header class="bg-white shadow sticky top-0 z-50">
    <div class="container mx-auto px-4 py-3 flex items-center justify-between gap-4">
      <a href="/" class="flex items-center gap-3 flex-shrink-0">
        <img src="/assets/new-AGPT-logo.svg" alt="AGPT Logo" class="w-12 h-12">
        <span class="font-bold text-gray-700 hidden sm:inline">AGPT Accounting and Business Consultancy</span>
      </a>
      <div class="flex-grow min-w-0 mx-4"><input type="search" id="searchBar" placeholder="Search by client, task, or owner..." class="w-full border px-3 py-2 rounded-lg focus:ring focus:ring-blue-200"></div>
      <div id="user-status" class="flex items-center gap-4 flex-shrink-0">
         <button id="addCardBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 hidden">Add Card</button>
         <button id="debugBtn" class="bg-purple-600 text-white px-2 py-1 rounded text-sm">Debug</button>
         <a id="loginBtn" href="/admin/login.html" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Login</a>
      </div>
    </div>
  </header>

  <!-- Debug Panel -->
  <div id="debugPanel" class="hidden bg-yellow-100 p-4 border-b">
    <h3 class="font-bold">Debug Information</h3>
    <div id="debugContent" class="debug-info"></div>
  </div>

  <main id="board-container" class="container mx-auto p-4 hidden">
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="bg-white rounded-lg shadow"><h2 class="text-xl font-bold p-4 border-b">To Do</h2><div id="col-todo" data-status="To Do" class="p-4 space-y-4 kanban-column"></div></div>
        <div class="bg-white rounded-lg shadow"><h2 class="text-xl font-bold p-4 border-b">In Progress</h2><div id="col-inprogress" data-status="In Progress" class="p-4 space-y-4 kanban-column"></div></div>
        <div class="bg-white rounded-lg shadow"><h2 class="text-xl font-bold p-4 border-b">Review</h2><div id="col-review" data-status="Review" class="p-4 space-y-4 kanban-column"></div></div>
        <div class="bg-white rounded-lg shadow"><h2 class="text-xl font-bold p-4 border-b">Done</h2><div id="col-done" data-status="Done" class="p-4 space-y-4 kanban-column"></div></div>
    </div>
  </main>
  <div id="login-prompt" class="container mx-auto p-8 text-center bg-white mt-8 rounded-lg shadow">
    <h2 class="text-2xl font-bold">Access Denied</h2>
    <p class="mt-2">Please log in to view the Kanban board.</p>
    <a href="/admin/login.html" class="mt-4 inline-block bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">Login</a>
  </div>

  <!-- Enhanced Error Modal -->
  <div id="errorModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
      <h2 id="errorTitle" class="text-2xl font-bold mb-4 text-red-600">Error</h2>
      <p id="errorMessage" class="mb-4"></p>
      <div id="errorDetails" class="debug-info mb-4 hidden"></div>
      <button id="errorClose" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Close</button>
    </div>
  </div>

  <div id="cardModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
      <h2 id="modalTitle" class="text-2xl font-bold mb-4">Add New Card</h2>
      <form id="cardForm">
        <input type="hidden" id="cardId" name="id">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div><label for="client" class="block mb-1">Client</label><input type="text" id="client" name="client" class="w-full border px-3 py-2 rounded" required></div>
          <div><label for="owner" class="block mb-1">Owner</label><input type="text" id="owner" name="owner" class="w-full border px-3 py-2 rounded"></div>
          <div class="md:col-span-2"><label for="task" class="block mb-1">Task</label><textarea id="task" name="task" rows="3" class="w-full border px-3 py-2 rounded" required></textarea></div>
          <div><label for="due_date" class="block mb-1">Due Date</label><input type="date" id="due_date" name="due_date" class="w-full border px-3 py-2 rounded"></div>
          <div><label for="category" class="block mb-1">Category</label><select id="category" name="category" class="w-full border px-3 py-2 rounded"></select></div>
          <div class="md:col-span-2 flex items-center"><input type="checkbox" id="blocker_flag" name="blocker_flag" class="mr-2"><label for="blocker_flag">Is this task blocked?</label></div>
        </div>
        <div class="mt-6 flex justify-end gap-4">
          <button type="button" id="deleteCardBtn" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 hidden">Delete</button>
          <button type="button" id="closeModalBtn" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500">Cancel</button>
          <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Save Card</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const categoryIcons = { 'Bookkeeping': 'ğŸ“š', 'Tax Filing (Current)': 'ğŸ“…', 'Preparation of AFS & filing of ITR': 'ğŸ“Š', 'General Information Sheet Preparation': 'ğŸ“‹', 'BIR LOA Processing': 'âœ‰ï¸ğŸ”', 'Open Case Processing - Tax Returns': 'ğŸ“‚ğŸ”“', 'Business Registration Processing': 'ğŸ¢â•', 'Business Closure Processing': 'ğŸ¢âœ–ï¸', 'Business Permit Renewal Processing': 'ğŸ”„ğŸ“„', 'Certificate of Gross Sales': 'ğŸ’µğŸ“„', 'Amendment of Articles of Incorporation': 'âœï¸ğŸ“œ', 'Annualized Payroll Preparation': 'ğŸ“†ğŸ‘¥', '2316 Preparation': 'ğŸ§¾ğŸ‘¤', 'Preparation of Interim Financial Statements': 'ğŸ“ˆğŸ“„', 'Preparation of In-House Financial Statements': 'ğŸ ğŸ“„', 'Other Engagement': 'â“' };
    let allCards = [];
    let currentUser = null;
    let debugMode = false;

    // Enhanced error handling function
    function showError(title, message, details = null) {
      const modal = document.getElementById('errorModal');
      const titleEl = document.getElementById('errorTitle');
      const messageEl = document.getElementById('errorMessage');
      const detailsEl = document.getElementById('errorDetails');
      
      titleEl.textContent = title;
      messageEl.textContent = message;
      
      if (details && debugMode) {
        detailsEl.textContent = JSON.stringify(details, null, 2);
        detailsEl.classList.remove('hidden');
      } else {
        detailsEl.classList.add('hidden');
      }
      
      modal.classList.add('is-open');
    }

    // Debug function
    async function updateDebugInfo() {
      if (!debugMode) return;
      
      try {
        const sessionResponse = await fetch('/debug/session', { credentials: 'include' });
        const sessionData = await sessionResponse.json();
        
        const userResponse = await fetch('/users/me', { credentials: 'include' });
        const userData = userResponse.ok ? await userResponse.json() : { error: 'Not authenticated' };
        
        const debugContent = document.getElementById('debugContent');
        debugContent.innerHTML = `
          <strong>Session Debug:</strong><br>
          Session ID: ${sessionData.sessionId}<br>
          Has Session: ${!!sessionData.session}<br>
          Session User: ${JSON.stringify(sessionData.session?.user || 'None')}<br>
          Cookies: ${sessionData.cookies || 'None'}<br><br>
          
          <strong>/users/me Response:</strong><br>
          Status: ${userResponse.status}<br>
          Data: ${JSON.stringify(userData)}<br><br>
          
          <strong>Current User State:</strong><br>
          ${JSON.stringify(currentUser || 'None')}
        `;
      } catch (error) {
        console.error('Debug update failed:', error);
      }
    }

    // Enhanced fetch wrapper with better error handling
    async function makeAuthenticatedRequest(url, options = {}) {
      console.log(`Making request to: ${url}`);
      console.log('Request options:', options);
      
      const defaultOptions = {
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json',
          ...options.headers
        }
      };
      
      const finalOptions = { ...defaultOptions, ...options };
      
      try {
        const response = await fetch(url, finalOptions);
        console.log(`Response status: ${response.status}`);
        
        if (!response.ok) {
          let errorData;
          try {
            errorData = await response.json();
          } catch (e) {
            errorData = { error: `HTTP ${response.status}` };
          }
          
          console.error('Request failed:', errorData);
          throw new Error(errorData.error || `Request failed with status ${response.status}`);
        }
        
        const data = response.status === 204 ? null : await response.json();
        console.log('Response data:', data);
        return data;
      } catch (error) {
        console.error('Request error:', error);
        throw error;
      }
    }

    function getDueDateColor(dueDate) { 
      if (!dueDate) return ''; 
      const today = new Date(); 
      today.setHours(0, 0, 0, 0); 
      const due = new Date(dueDate); 
      const diffTime = due - today; 
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
      if (diffDays <= 3) return 'color-stripe-red'; 
      if (diffDays <= 14) return 'color-stripe-amber'; 
      return 'color-stripe-green'; 
    }

    function renderCard(card) {
      const dueDateColor = getDueDateColor(card.due_date);
      const formattedDueDate = card.due_date ? new Date(card.due_date).toLocaleDateString() : 'N/A';
      const icon = categoryIcons[card.category] || 'â“';
      const dateText = card.completed_at ? `Completed: ${new Date(card.completed_at).toLocaleDateString()}` : `Due: ${formattedDueDate}`;
      return `<div id="card-${card.id}" data-id="${card.id}" class="kanban-card bg-gray-50 p-4 rounded-lg shadow-sm ${dueDateColor}">${card.blocker_flag ? '<div class="blocker-overlay">âš ï¸</div>' : ''}<div class="flex items-start"><div class="text-2xl mr-3">${icon}</div><div><h3 class="font-bold">${card.client}</h3><p class="text-gray-700">${card.task}</p><div class="text-sm text-gray-500 mt-2"><span>${card.owner || 'Unassigned'}</span> | <span>${dateText}</span></div></div></div></div>`;
    }

    function renderBoard(cardsToRender) {
        document.querySelectorAll('.kanban-column').forEach(c => c.innerHTML = '');
        cardsToRender.forEach(card => {
            const statusId = `col-${card.status.toLowerCase().replace(' ', '')}`;
            const column = document.getElementById(statusId);
            if (column) { column.innerHTML += renderCard(card); }
        });
        if (currentUser) { addCardClickListeners(); }
    }

    function applySearchAndRender() {
        const searchTerm = document.getElementById('searchBar').value.toLowerCase();
        if (!searchTerm) {
            renderBoard(allCards);
            return;
        }
        const filteredCards = allCards.filter(c => c.client.toLowerCase().includes(searchTerm) || c.task.toLowerCase().includes(searchTerm) || (c.owner && c.owner.toLowerCase().includes(searchTerm)));
        renderBoard(filteredCards);
    }

    async function fetchAndRenderCards() {
        try {
            console.log('Fetching kanban cards...');
            const cards = await makeAuthenticatedRequest('/api/kanban');
            
            document.getElementById('board-container').classList.remove('hidden');
            document.getElementById('login-prompt').classList.add('hidden');
            allCards = cards;
            applySearchAndRender();
            
            if (debugMode) updateDebugInfo();
        } catch (error) {
            console.error('Failed to fetch cards:', error);
            showError('Authentication Error', error.message);
            document.getElementById('board-container').classList.add('hidden');
            document.getElementById('login-prompt').classList.remove('hidden');
        }
    }

    function addCardClickListeners() { 
      document.querySelectorAll('.kanban-card').forEach(el => { 
        el.addEventListener('click', () => openModal(el.dataset.id)); 
      }); 
    }

    async function updateUserStatus() {
        const userStatusDiv = document.getElementById('user-status');
        const addCardBtn = document.getElementById('addCardBtn');
        const loginBtn = document.getElementById('loginBtn');
        
        try {
            console.log('Checking user status...');
            currentUser = await makeAuthenticatedRequest('/users/me');
            console.log('Current user:', currentUser);

            loginBtn.style.display = 'none';
            addCardBtn.style.display = 'inline-block';

            // Remove existing user info
            const existingWelcome = userStatusDiv.querySelector('.welcome-text');
            const existingLogout = userStatusDiv.querySelector('#logoutBtn');
            if (existingWelcome) existingWelcome.remove();
            if (existingLogout) existingLogout.remove();

            const welcomeSpan = document.createElement('span');
            welcomeSpan.className = 'text-gray-600 welcome-text';
            welcomeSpan.textContent = `Welcome, ${currentUser.username}!`;

            const logoutBtn = document.createElement('button');
            logoutBtn.id = 'logoutBtn';
            logoutBtn.className = 'bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700';
            logoutBtn.textContent = 'Logout';

            userStatusDiv.appendChild(welcomeSpan);
            userStatusDiv.appendChild(logoutBtn);

            logoutBtn.addEventListener('click', async () => {
                try {
                    await makeAuthenticatedRequest('/admin/logout', { method: 'POST' });
                    window.location.reload();
                } catch (error) {
                    console.error('Logout failed:', error);
                    showError('Logout Error', error.message);
                }
            });

            if (debugMode) updateDebugInfo();

        } catch (error) {
            console.error('User status check failed:', error);
            currentUser = null;
            addCardBtn.style.display = 'none';
            loginBtn.style.display = 'inline-block';
        }
    }

    const modal = document.getElementById('cardModal');
    const form = document.getElementById('cardForm');
    const categorySelect = document.getElementById('category');
    Object.keys(categoryIcons).forEach(cat => { 
      const opt = document.createElement('option'); 
      opt.value = cat; 
      opt.textContent = cat; 
      categorySelect.appendChild(opt); 
    });

    function openModal(cardId) {
      form.reset();
      const deleteBtn = document.getElementById('deleteCardBtn');
      if (cardId) {
        const card = allCards.find(c => c.id == cardId);
        document.getElementById('modalTitle').textContent = 'Edit Card';
        form.id.value = card.id;
        form.client.value = card.client;
        form.owner.value = card.owner;
        form.task.value = card.task;
        form.due_date.value = card.due_date ? card.due_date.split('T')[0] : '';
        form.category.value = card.category;
        form.blocker_flag.checked = card.blocker_flag;
        if (currentUser && currentUser.role === 'admin') {
            deleteBtn.classList.remove('hidden');
        } else {
            deleteBtn.classList.add('hidden');
        }
      } else {
        document.getElementById('modalTitle').textContent = 'Add New Card';
        deleteBtn.classList.add('hidden');
      }
      modal.classList.add('is-open');
    }
    
    function closeModal() { 
      modal.classList.remove('is-open'); 
    }

    document.addEventListener('DOMContentLoaded', () => {
        console.log('DOM Content Loaded');
        
        updateUserStatus();
        fetchAndRenderCards();
        
        document.getElementById('searchBar').addEventListener('input', applySearchAndRender);
        setInterval(fetchAndRenderCards, 30000); // Increased interval

        // Debug button
        document.getElementById('debugBtn').addEventListener('click', () => {
          debugMode = !debugMode;
          const panel = document.getElementById('debugPanel');
          if (debugMode) {
            panel.classList.remove('hidden');
            updateDebugInfo();
          } else {
            panel.classList.add('hidden');
          }
        });

        document.getElementById('addCardBtn').addEventListener('click', () => openModal());
        document.getElementById('closeModalBtn').addEventListener('click', closeModal);
        document.getElementById('errorClose').addEventListener('click', () => {
          document.getElementById('errorModal').classList.remove('is-open');
        });

        document.getElementById('cardForm').addEventListener('submit', async e => {
          e.preventDefault();
          const cardId = form.id.value;
          const cardData = {
            client: form.client.value, 
            task: form.task.value, 
            owner: form.owner.value,
            due_date: form.due_date.value || null, 
            category: form.category.value,
            blocker_flag: form.blocker_flag.checked,
            status: cardId ? allCards.find(c=>c.id==cardId).status : 'To Do'
          };
          
          try {
            const url = cardId ? `/api/kanban/${cardId}` : '/api/kanban';
            const method = cardId ? 'PUT' : 'POST';
            
            await makeAuthenticatedRequest(url, { 
              method, 
              body: JSON.stringify(cardData) 
            });
            
            closeModal(); 
            fetchAndRenderCards();
          } catch (error) {
            showError('Save Failed', error.message, { cardData, url, method });
          }
        });

        document.getElementById('deleteCardBtn').addEventListener('click', async () => {
            const cardId = form.id.value;
            if (cardId && confirm('Are you sure you want to delete this card?')) {
                try {
                    await makeAuthenticatedRequest(`/api/kanban/${cardId}`, { method: 'DELETE' });
                    closeModal(); 
                    fetchAndRenderCards();
                } catch (error) {
                    showError('Delete Failed', error.message);
                }
            }
        });

        const columns = document.querySelectorAll('.kanban-column');
        columns.forEach(col => {
            new Sortable(col, {
                group: 'kanban', 
                animation: 150, 
                ghostClass: 'bg-blue-100',
                onEnd: async (evt) => {
                    const cardId = evt.item.dataset.id;
                    const newStatus = evt.to.dataset.status;
                    const card = allCards.find(c => c.id == cardId);
                    
                    if (card.status === newStatus) return;

                    try {
                        await makeAuthenticatedRequest(`/api/kanban/${cardId}/status`, {
                            method: 'PATCH',
                            body: JSON.stringify({ status: newStatus })
                        });
                        
                        fetchAndRenderCards();
                    } catch (error) {
                        console.error('Status update failed:', error);
                        showError('Status Update Failed', error.message);
                        fetchAndRenderCards(); // Revert on error
                    }
                }
            });
        });
    });
  </script>
</body>
</html>