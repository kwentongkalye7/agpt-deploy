<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AGPT Kanban Board</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <link rel="stylesheet" href="/assets/css/custom.css">
  <style>
    .kanban-column { min-height: 400px; }
    .kanban-card { cursor: grab; position: relative; border-left: 5px solid transparent; }
    .kanban-card:active { cursor: grabbing; }
    .color-stripe-green { border-left-color: #28a745; }
    .color-stripe-amber { border-left-color: #ffc107; }
    .color-stripe-red { border-left-color: #dc3545; }
    .blocker-overlay { position: absolute; top: 8px; right: 8px; font-size: 1.5rem; line-height: 1; }
    .modal { display: none; } .modal.is-open { display: flex; }
  </style>
</head>
<body class="bg-gray-100 font-sans">
  <header class="bg-white shadow sticky top-0 z-50">
    <div class="container mx-auto px-4 py-3 flex items-center justify-between gap-4">
      <a href="/" class="flex items-center gap-3 flex-shrink-0">
        <img src="/assets/new-AGPT-logo.svg" alt="AGPT Logo" class="w-12 h-12">
        <span class="font-bold text-gray-700 hidden sm:inline">AGPT Accounting and Business Consultancy</span>
      </a>
      <div class="flex-grow min-w-0 mx-4"><input type="search" id="searchBar" placeholder="Search by client, task, or owner..." class="w-full border px-3 py-2 rounded-lg focus:ring focus:ring-blue-200"></div>
      <div id="user-status" class="flex items-center gap-4 flex-shrink-0">
         <button id="addCardBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 hidden">Add Card</button>
         <a id="loginBtn" href="/admin/login.html" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Login</a>
      </div>
    </div>
  </header>

  <main id="board-container" class="container mx-auto p-4 hidden">
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="bg-white rounded-lg shadow"><h2 class="text-xl font-bold p-4 border-b">To Do</h2><div id="col-todo" data-status="To Do" class="p-4 space-y-4 kanban-column"></div></div>
        <div class="bg-white rounded-lg shadow"><h2 class="text-xl font-bold p-4 border-b">In Progress</h2><div id="col-inprogress" data-status="In Progress" class="p-4 space-y-4 kanban-column"></div></div>
        <div class="bg-white rounded-lg shadow"><h2 class="text-xl font-bold p-4 border-b">Review</h2><div id="col-review" data-status="Review" class="p-4 space-y-4 kanban-column"></div></div>
        <div class="bg-white rounded-lg shadow"><h2 class="text-xl font-bold p-4 border-b">Done</h2><div id="col-done" data-status="Done" class="p-4 space-y-4 kanban-column"></div></div>
    </div>
  </main>
  <div id="login-prompt" class="container mx-auto p-8 text-center bg-white mt-8 rounded-lg shadow">
    <h2 class="text-2xl font-bold">Access Denied</h2>
    <p class="mt-2">Please log in to view the Kanban board.</p>
    <a href="/admin/login.html" class="mt-4 inline-block bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">Login</a>
  </div>

  <div id="cardModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
      <h2 id="modalTitle" class="text-2xl font-bold mb-4">Add New Card</h2>
      <form id="cardForm">
        <input type="hidden" id="cardId" name="id">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div><label for="client" class="block mb-1">Client</label><input type="text" id="client" name="client" class="w-full border px-3 py-2 rounded" required></div>
          <div><label for="owner" class="block mb-1">Owner</label><input type="text" id="owner" name="owner" class="w-full border px-3 py-2 rounded"></div>
          <div class="md:col-span-2"><label for="task" class="block mb-1">Task</label><textarea id="task" name="task" rows="3" class="w-full border px-3 py-2 rounded" required></textarea></div>
          <div><label for="due_date" class="block mb-1">Due Date</label><input type="date" id="due_date" name="due_date" class="w-full border px-3 py-2 rounded"></div>
          <div><label for="category" class="block mb-1">Category</label><select id="category" name="category" class="w-full border px-3 py-2 rounded"></select></div>
          <div class="md:col-span-2 flex items-center"><input type="checkbox" id="blocker_flag" name="blocker_flag" class="mr-2"><label for="blocker_flag">Is this task blocked?</label></div>
        </div>
        <div class="mt-6 flex justify-end gap-4">
          <button type="button" id="deleteCardBtn" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 hidden">Delete</button>
          <button type="button" id="closeModalBtn" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500">Cancel</button>
          <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Save Card</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const categoryIcons = { 'Bookkeeping': 'ğŸ“š', 'Tax Filing (Current)': 'ğŸ“…', 'Preparation of AFS & filing of ITR': 'ğŸ“Š', 'General Information Sheet Preparation': 'ğŸ“‹', 'BIR LOA Processing': 'âœ‰ï¸ğŸ”', 'Open Case Processing - Tax Returns': 'ğŸ“‚ğŸ”“', 'Business Registration Processing': 'ğŸ¢â•', 'Business Closure Processing': 'ğŸ¢âœ–ï¸', 'Business Permit Renewal Processing': 'ğŸ”„ğŸ“„', 'Certificate of Gross Sales': 'ğŸ’µğŸ“„', 'Amendment of Articles of Incorporation': 'âœï¸ğŸ“œ', 'Annualized Payroll Preparation': 'ğŸ“†ğŸ‘¥', '2316 Preparation': 'ğŸ§¾ğŸ‘¤', 'Preparation of Interim Financial Statements': 'ğŸ“ˆğŸ“„', 'Preparation of In-House Financial Statements': 'ğŸ ğŸ“„', 'Other Engagement': 'â“' };
    let allCards = [];
    let currentUser = null;

    function getDueDateColor(dueDate) { if (!dueDate) return ''; const today = new Date(); today.setHours(0, 0, 0, 0); const due = new Date(dueDate); const diffTime = due - today; const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); if (diffDays <= 3) return 'color-stripe-red'; if (diffDays <= 14) return 'color-stripe-amber'; return 'color-stripe-green'; }

    function renderCard(card) {
      const dueDateColor = getDueDateColor(card.due_date);
      const formattedDueDate = card.due_date ? new Date(card.due_date).toLocaleDateString() : 'N/A';
      const icon = categoryIcons[card.category] || 'â“';
      const dateText = card.completed_at ? `Completed: ${new Date(card.completed_at).toLocaleDateString()}` : `Due: ${formattedDueDate}`;
      return `<div id="card-${card.id}" data-id="${card.id}" class="kanban-card bg-gray-50 p-4 rounded-lg shadow-sm ${dueDateColor}">${card.blocker_flag ? '<div class="blocker-overlay">âš ï¸</div>' : ''}<div class="flex items-start"><div class="text-2xl mr-3">${icon}</div><div><h3 class="font-bold">${card.client}</h3><p class="text-gray-700">${card.task}</p><div class="text-sm text-gray-500 mt-2"><span>${card.owner || 'Unassigned'}</span> | <span>${dateText}</span></div></div></div></div>`;
    }

    function renderBoard(cardsToRender) {
        document.querySelectorAll('.kanban-column').forEach(c => c.innerHTML = '');
        cardsToRender.forEach(card => {
            const statusId = `col-${card.status.toLowerCase().replace(' ', '')}`;
            const column = document.getElementById(statusId);
            if (column) { column.innerHTML += renderCard(card); }
        });
        if (currentUser) { addCardClickListeners(); }
    }

    function applySearchAndRender() {
        const searchTerm = document.getElementById('searchBar').value.toLowerCase();
        if (!searchTerm) {
            renderBoard(allCards);
            return;
        }
        const filteredCards = allCards.filter(c => c.client.toLowerCase().includes(searchTerm) || c.task.toLowerCase().includes(searchTerm) || (c.owner && c.owner.toLowerCase().includes(searchTerm)));
        renderBoard(filteredCards);
    }

    async function fetchAndRenderCards() {
        try {
            const res = await fetch('/api/kanban', { credentials: 'include' });
            if (!res.ok) throw new Error('Login required');
            document.getElementById('board-container').classList.remove('hidden');
            document.getElementById('login-prompt').classList.add('hidden');
            allCards = await res.json();
            applySearchAndRender();
        } catch (e) {
            document.getElementById('board-container').classList.add('hidden');
            document.getElementById('login-prompt').classList.remove('hidden');
        }
    }

    function addCardClickListeners() { document.querySelectorAll('.kanban-card').forEach(el => { el.addEventListener('click', () => openModal(el.dataset.id)); }); }

    async function updateUserStatus() {
        const userStatusDiv = document.getElementById('user-status');
        const addCardBtn = document.getElementById('addCardBtn');
        const loginBtn = document.getElementById('loginBtn');
        try {
            const res = await fetch('/users/me', { credentials: 'include' });
            if (!res.ok) throw new Error('Not logged in');
            currentUser = await res.json();

            loginBtn.style.display = 'none';
            addCardBtn.style.display = 'inline-block';

            const welcomeSpan = document.createElement('span');
            welcomeSpan.className = 'text-gray-600';
            welcomeSpan.textContent = `Welcome, ${currentUser.username}!`;

            const logoutBtn = document.createElement('button');
            logoutBtn.id = 'logoutBtn';
            logoutBtn.className = 'bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700';
            logoutBtn.textContent = 'Logout';

            userStatusDiv.appendChild(welcomeSpan);
            userStatusDiv.appendChild(logoutBtn);

            logoutBtn.addEventListener('click', async () => {
                await fetch('/admin/logout', { method: 'POST', credentials: 'include' });
                window.location.reload();
            });

        } catch (e) {
            currentUser = null;
            addCardBtn.style.display = 'none';
            loginBtn.style.display = 'inline-block';
        }
    }

    const modal = document.getElementById('cardModal');
    const form = document.getElementById('cardForm');
    const categorySelect = document.getElementById('category');
    Object.keys(categoryIcons).forEach(cat => { const opt = document.createElement('option'); opt.value = cat; opt.textContent = cat; categorySelect.appendChild(opt); });

    function openModal(cardId) {
      form.reset();
      const deleteBtn = document.getElementById('deleteCardBtn');
      if (cardId) {
        const card = allCards.find(c => c.id == cardId);
        document.getElementById('modalTitle').textContent = 'Edit Card';
        form.id.value = card.id;
        form.client.value = card.client;
        form.owner.value = card.owner;
        form.task.value = card.task;
        form.due_date.value = card.due_date ? card.due_date.split('T')[0] : '';
        form.category.value = card.category;
        form.blocker_flag.checked = card.blocker_flag;
        if (currentUser && currentUser.role === 'admin') {
            deleteBtn.classList.remove('hidden');
        } else {
            deleteBtn.classList.add('hidden');
        }
      } else {
        document.getElementById('modalTitle').textContent = 'Add New Card';
        deleteBtn.classList.add('hidden');
      }
      modal.classList.add('is-open');
    }
    function closeModal() { modal.classList.remove('is-open'); }

    document.addEventListener('DOMContentLoaded', () => {
        updateUserStatus();
        fetchAndRenderCards();
        document.getElementById('searchBar').addEventListener('input', applySearchAndRender);
        setInterval(fetchAndRenderCards, 15000);

        document.getElementById('addCardBtn').addEventListener('click', () => openModal());
        document.getElementById('closeModalBtn').addEventListener('click', closeModal);
        document.getElementById('cardForm').addEventListener('submit', async e => {
          e.preventDefault();
          const cardId = form.id.value;
          const cardData = {
            client: form.client.value, task: form.task.value, owner: form.owner.value,
            due_date: form.due_date.value || null, category: form.category.value,
            blocker_flag: form.blocker_flag.checked,
            status: cardId ? allCards.find(c=>c.id==cardId).status : 'To Do'
          };
          const url = cardId ? `/api/kanban/${cardId}` : '/api/kanban';
          const method = cardId ? 'PUT' : 'POST';
          const res = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, credentials: 'include', body: JSON.stringify(cardData) });
          if(res.ok) { closeModal(); fetchAndRenderCards(); } else { alert('Save failed. You may need to log in.'); }
        });
        document.getElementById('deleteCardBtn').addEventListener('click', async () => {
            const cardId = form.id.value;
            if (cardId && confirm('Are you sure you want to delete this card?')) {
                const res = await fetch(`/api/kanban/${cardId}`, { method: 'DELETE', credentials: 'include' });
                if (res.ok) { closeModal(); fetchAndRenderCards(); } else { alert('Delete failed. Only admins can delete cards.'); }
            }
        });

        const columns = document.querySelectorAll('.kanban-column');
        columns.forEach(col => {
            new Sortable(col, {
                group: 'kanban', animation: 150, ghostClass: 'bg-blue-100',
                onEnd: async (evt) => {
                    const cardId = evt.item.dataset.id;
                    const newStatus = evt.to.dataset.status;
                    const card = allCards.find(c => c.id == cardId);
                    if (card.status === newStatus) return;

                    const res = await fetch(`/api/kanban/${cardId}/status`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ status: newStatus })
                    });

                    if (!res.ok) {
                        alert('Failed to update status. You may need to log in.');
                        fetchAndRenderCards();
                    } else {
                        fetchAndRenderCards();
                    }
                }
            });
        });
    });
  </script>
</body>
</html>