<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Team Login - AGPT</title>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'agpt-blue': '#0057B8',
            'agpt-blue-dark': '#00468A',
            'agpt-blue-light': '#1374D8',
            'growth-green': '#00B389',
            'growth-green-dark': '#008562',
            'neutral-gray': '#707070',
            'header-black': '#000000',
            'brand-white': '#FFFFFF',
            'sky-mist': '#E8F2FA',
            'mint-haze': '#E2F4EE'
          }
        }
      }
    }
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/assets/css/custom.css">
</head>
<body class="font-sans antialiased bg-sky-mist text-neutral-gray">
  <div id="page-container" class="min-h-screen flex flex-col items-center justify-center p-4 w-full">
    <div class="flex items-center mb-6">
      <img src="/assets/agpt.jpg" alt="AGPT Logo" class="w-12 h-12 mr-4">
      <h1 class="text-xl font-bold text-header-black">AGPT Accounting and Business Consultancy</h1>
    </div>

    <!-- Login Section -->
    <div id="loginSection" class="max-w-md w-full bg-brand-white p-6 rounded-2xl shadow-sm card-outline">
      <h2 class="text-2xl font-bold mb-4 text-center text-header-black">Team Login</h2>
      <form id="loginForm" class="space-y-4">
        <div>
          <label for="username" class="block mb-1 text-neutral-gray font-medium">Username</label>
          <input id="username" name="username" type="text" class="w-full border border-[#DDE3EA] px-3 py-2 rounded focus:outline-none focus:border-agpt-blue" required />
        </div>
        <div>
          <label for="password" class="block mb-1 text-neutral-gray font-medium">Password</label>
          <input id="password" name="password" type="password" class="w-full border border-[#DDE3EA] px-3 py-2 rounded focus:outline-none focus:border-agpt-blue" required />
        </div>
        <button type="submit" class="w-full bg-agpt-blue text-brand-white py-3 rounded-full font-semibold hover:bg-agpt-blue-dark transition">Login</button>
        <p class="text-center text-sm pt-2">Don't have an account? <a href="/admin/register.html" class="text-agpt-blue font-semibold hover:text-growth-green transition">Register here</a>.</p>
      </form>
    </div>

    <!-- Post Management Section (For Admins) -->
    <div id="postSection" class="hidden w-full max-w-5xl mx-4 bg-brand-white p-6 md:p-10 rounded-2xl shadow-sm card-outline space-y-6">
      <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
        <h2 class="text-2xl font-bold text-header-black">Manage Insights</h2>
        <div>
          <a href="/admin/users.html" class="bg-agpt-blue text-brand-white px-4 py-2 rounded-full hover:bg-agpt-blue-dark mr-2 font-semibold inline-block">Manage Users</a>
          <button id="logoutBtnAdmin" class="bg-neutral-gray text-brand-white px-4 py-2 rounded-full hover:bg-header-black font-semibold">Logout</button>
        </div>
      </div>
      <div id="postList" class="space-y-4"></div>
      <hr class="my-6" />
      <h3 class="text-xl font-semibold mb-2 text-header-black">Create / Edit Insight</h3>
      <form id="postForm" class="space-y-4 bg-brand-white p-6 rounded-xl shadow-sm card-outline">
        <input type="hidden" id="editPostId" name="_id" />
        <div><label for="title" class="block mb-1 text-neutral-gray font-medium">Title</label><input id="title" name="title" type="text" class="w-full border border-[#DDE3EA] px-3 py-2 rounded focus:outline-none focus:border-agpt-blue" required /></div>
        <div><label for="excerpt" class="block mb-1 text-neutral-gray font-medium">Excerpt</label><textarea id="excerpt" name="excerpt" rows="3" class="w-full border border-[#DDE3EA] px-3 py-2 rounded focus:outline-none focus:border-agpt-blue" required></textarea></div>
        <div><label for="slug" class="block mb-1 text-neutral-gray font-medium">Slug</label><input id="slug" name="slug" type="text" class="w-full border border-[#DDE3EA] px-3 py-2 rounded focus:outline-none focus:border-agpt-blue" required /></div>
        <div class="flex flex-wrap gap-2"><button type="submit" class="bg-growth-green text-brand-white py-2 px-4 rounded-full hover:bg-growth-green-dark font-semibold">Save</button><button type="button" id="cancelEditBtn" class="bg-neutral-gray text-brand-white py-2 px-4 rounded-full hover:bg-header-black">Cancel</button></div>
      </form>
    </div>
  </div>

  <script>
    let allPosts = [];

    async function handleUserSession() {
      const loginSection = document.getElementById('loginSection');
      const postSection = document.getElementById('postSection');
      try {
        const res = await fetch('/users/me', { credentials: 'include' });
        if (!res.ok) throw new Error('Not authenticated');
        const user = await res.json();

        loginSection.classList.add('hidden');
        if (user.role === 'admin') {
          postSection.classList.remove('hidden');
          loadAndRenderPosts();
        } else {
          document.getElementById('page-container').innerHTML = `
            <div class="max-w-md w-full bg-brand-white p-6 rounded-2xl shadow-sm card-outline text-center">
              <div class="flex items-center justify-center mb-6">
                <img src="/assets/new-AGPT-logo.svg" alt="AGPT Logo" class="w-12 h-12 mr-4">
                <h1 class="text-xl font-bold text-header-black">AGPT Accounting and Business Consultancy</h1>
              </div>
              <h2 class="text-2xl font-bold mb-4 text-header-black">Welcome, ${user.username}!</h2>
              <p>Your role is 'Employee'. You can access the Kanban board.</p>
              <a href="/admin/kanban.html" class="mt-4 inline-block w-full bg-agpt-blue text-brand-white py-3 rounded-full hover:bg-agpt-blue-dark font-semibold">Go to Kanban Board</a>
              <button id="logoutBtnEmployee" class="mt-2 w-full bg-neutral-gray text-brand-white py-3 rounded-full hover:bg-header-black font-semibold">Logout</button>
            </div>`;
          document.getElementById('logoutBtnEmployee').addEventListener('click', logout);
        }
      } catch (e) {
        loginSection.classList.remove('hidden');
        postSection.classList.add('hidden');
      }
    }

    async function logout() {
      await fetch('/admin/logout', { method: 'POST', credentials: 'include' });
      window.location.reload();
    }

    async function fetchPosts() {
      const res = await fetch('/api/posts');
      return res.json();
    }

    function renderPosts(posts) {
      allPosts = posts;
      const list = document.getElementById('postList');
      list.innerHTML = '';
      posts.forEach(p => {
        const el = document.createElement('div');
        el.className = 'bg-brand-white p-4 rounded-xl shadow-sm card-outline flex justify-between items-center';
        el.innerHTML = `
          <div>
            <h4 class="font-semibold mb-1">${p.title}</h4>
            <small class="text-neutral-gray">/${p.slug}</small>
          </div>
          <div class="space-x-2">
            <button data-id="${p.id}" class="editBtn bg-agpt-blue text-brand-white px-3 py-1 rounded hover:bg-agpt-blue-dark">Edit</button>
            <button data-id="${p.id}" class="deleteBtn bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">Delete</button>
          </div>
        `;
        list.appendChild(el);
      });
      document.querySelectorAll('.editBtn').forEach(btn => btn.onclick = () => startEdit(btn.dataset.id));
      document.querySelectorAll('.deleteBtn').forEach(btn => btn.onclick = () => deletePost(btn.dataset.id));
    }

    async function loadAndRenderPosts() {
      const posts = await fetchPosts();
      renderPosts(posts);
    }

    async function deletePost(id) {
      if (!confirm('Delete this insight?')) return;
      const res = await fetch(`/api/posts/${id}`, { method: 'DELETE', credentials: 'include' });
      if (res.ok) loadAndRenderPosts();
      else alert('Delete failed');
    }

    function startEdit(id) {
      const post = allPosts.find(p => p.id == id);
      const form = document.getElementById('postForm');
      form.editPostId.value = post.id;
      form.title.value = post.title;
      form.excerpt.value = post.excerpt;
      form.slug.value = post.slug;
    }

    document.addEventListener('DOMContentLoaded', () => {
      handleUserSession();

      document.getElementById('loginForm').addEventListener('submit', async e => {
        e.preventDefault();
        const { username, password } = e.target;
        const res = await fetch('/admin/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ username: username.value, password: password.value })
        });
        if (res.ok) {
          handleUserSession();
        } else {
          alert('Login failed. Please check your username and password.');
        }
      });

      const logoutBtnAdmin = document.getElementById('logoutBtnAdmin');
      if (logoutBtnAdmin) logoutBtnAdmin.addEventListener('click', logout);

      const postForm = document.getElementById('postForm');
      if (postForm) {
        postForm.addEventListener('submit', async e => {
          e.preventDefault();
          const form = e.target;
          const id = form.editPostId.value;
          const payload = { title: form.title.value, excerpt: form.excerpt.value, slug: form.slug.value };
          const method = id ? 'PUT' : 'POST';
          const url = id ? `/api/posts/${id}` : '/api/posts';
          const res = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(payload)
          });
          if (res.ok) {
            form.reset();
            form.editPostId.value = '';
            loadAndRenderPosts();
          } else alert('Save failed');
        });
      }

      const cancelEditBtn = document.getElementById('cancelEditBtn');
      if(cancelEditBtn) cancelEditBtn.addEventListener('click', () => { document.getElementById('postForm').reset(); });
    });
  </script>
</body>
</html>
